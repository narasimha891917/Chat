<!-- Save as chat_app.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Multi-User Chat App with Calls</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    #chat, #users, #status { margin: 10px 0; }
    .msg { padding: 5px; margin: 2px; background: #fff; border-radius: 4px; }
    #localVideo, #remoteVideo { width: 45%; margin: 10px; }
    #videoContainer, #audioContainer { display: none; }
    .online { color: green; } .offline { color: red; }
    .typing { font-style: italic; }
    button { margin: 5px; }
  </style>
</head>
<body>

<h2>Chat App with Video & Audio Call</h2>

<div>
  Username: <input id="username" placeholder="Enter your name" />
  <button onclick="register()">Join Chat</button>
</div>

<div id="main" style="display:none;">
  <div id="status">Status: <span id="myStatus">Offline</span></div>
  <div id="users"></div>

  <div id="chatBox">
    <div id="chat" style="height:200px; overflow-y:scroll;"></div>
    <input id="message" placeholder="Type message..." oninput="sendTyping()" />
    <button onclick="sendMessage()">Send</button>
    <div id="typingStatus"></div>
  </div>

  <h3>Call Options</h3>
  <button onclick="startVideoCall()">Start Video Call</button>
  <button onclick="startAudioCall()">Start Audio Call</button>
  <button onclick="endCall()">End Call</button>

  <div id="videoContainer">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div id="audioContainer">
    <audio id="remoteAudio" autoplay></audio>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD_5OXqGIcR2yH_nGC8GVgmLwJfJaQnmuw",
    authDomain: "student-dashboard-821ae.firebaseapp.com",
    projectId: "student-dashboard-821ae",
    databaseURL: "https://student-dashboard-821ae-default-rtdb.firebaseio.com",
    storageBucket: "student-dashboard-821ae.appspot.com",
    messagingSenderId: "785480958148",
    appId: "1:785480958148:web:bb187cfe8d969aafca0991"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = '';
  let typingTimeout = null;

  function register() {
    username = document.getElementById('username').value.trim();
    if (!username) return alert("Enter username!");
    document.getElementById('main').style.display = 'block';
    db.ref('users/' + username).set({ online: true });
    db.ref('users/' + username).onDisconnect().remove();
    document.getElementById('myStatus').textContent = 'Online';
    listenForUsers();
    listenForMessages();
    listenTyping();
    listenForCalls();
  }

  function sendMessage() {
    const msg = document.getElementById('message').value.trim();
    if (!msg) return;
    const id = Date.now();
    db.ref('messages/' + id).set({ user: username, text: msg, seen: false });
    document.getElementById('message').value = '';
  }

  function listenForMessages() {
    db.ref('messages').on('child_added', snap => {
      const msg = snap.val();
      const id = snap.key;
      const div = document.createElement('div');
      div.className = 'msg';
      div.textContent = `${msg.user}: ${msg.text}`;
      document.getElementById('chat').appendChild(div);
      document.getElementById('chat').scrollTop = 9999;

      if (msg.user !== username && !msg.seen) {
        db.ref('messages/' + id).update({ seen: true });
        setTimeout(() => db.ref('messages/' + id).remove(), 60000);
      }
    });
  }

  function listenForUsers() {
    db.ref('users').on('value', snap => {
      const users = snap.val();
      let html = "<b>Users:</b><br>";
      for (let u in users) {
        if (u !== username) html += `${u} <span class="${users[u].online ? 'online' : 'offline'}">${users[u].online ? 'Online' : 'Offline'}</span><br>`;
      }
      document.getElementById('users').innerHTML = html;
    });
  }

  function sendTyping() {
    db.ref('typing').set({ user: username });
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => db.ref('typing').remove(), 2000);
  }

  function listenTyping() {
    db.ref('typing').on('value', snap => {
      const val = snap.val();
      document.getElementById('typingStatus').textContent = val && val.user !== username ? `${val.user} is typing...` : '';
    });
  }

  // Call functionality
  let localStream = null;
  let peer = null;

  async function startVideoCall() {
    document.getElementById('videoContainer').style.display = 'block';
    document.getElementById('audioContainer').style.display = 'none';
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
    makePeerConnection();
    db.ref('calls').set({ from: username, type: 'video' });
  }

  async function startAudioCall() {
    document.getElementById('audioContainer').style.display = 'block';
    document.getElementById('videoContainer').style.display = 'none';
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    makePeerConnection();
    db.ref('calls').set({ from: username, type: 'audio' });
  }

  function makePeerConnection() {
    peer = new RTCPeerConnection();
    localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

    peer.ontrack = event => {
      const remoteStream = new MediaStream([event.track]);
      if (event.track.kind === "video") document.getElementById('remoteVideo').srcObject = remoteStream;
      else if (event.track.kind === "audio") document.getElementById('remoteAudio').srcObject = remoteStream;
    };

    peer.onicecandidate = e => {
      if (e.candidate) {
        db.ref('ice/' + username).push(e.candidate.toJSON());
      }
    };

    peer.createOffer().then(offer => {
      peer.setLocalDescription(offer);
      db.ref('offers/' + username).set(offer);
    });
  }

  function listenForCalls() {
    db.ref('calls').on('value', async snap => {
      const call = snap.val();
      if (call && call.from !== username) {
        const accept = confirm(`${call.from} is calling (${call.type}). Accept?`);
        if (!accept) return;

        localStream = await navigator.mediaDevices.getUserMedia({
          video: call.type === 'video',
          audio: true
        });

        if (call.type === 'video') {
          document.getElementById('videoContainer').style.display = 'block';
          document.getElementById('audioContainer').style.display = 'none';
          document.getElementById('localVideo').srcObject = localStream;
        } else {
          document.getElementById('audioContainer').style.display = 'block';
          document.getElementById('videoContainer').style.display = 'none';
        }

        peer = new RTCPeerConnection();
        localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
        peer.ontrack = e => {
          const remoteStream = new MediaStream([e.track]);
          if (e.track.kind === 'video') document.getElementById('remoteVideo').srcObject = remoteStream;
          else document.getElementById('remoteAudio').srcObject = remoteStream;
        };
        peer.onicecandidate = e => {
          if (e.candidate) db.ref('ice/' + call.from).push(e.candidate.toJSON());
        };

        const offer = (await db.ref('offers/' + call.from).get()).val();
        peer.setRemoteDescription(offer);
        const answer = await peer.createAnswer();
        peer.setLocalDescription(answer);
        db.ref('answers/' + call.from).set(answer);

        db.ref('ice/' + username).on('child_added', snap => {
          peer.addIceCandidate(new RTCIceCandidate(snap.val()));
        });
      }
    });

    db.ref('answers/' + username).on('value', snap => {
      const answer = snap.val();
      if (answer && peer) peer.setRemoteDescription(answer);
    });

    db.ref('ice/' + username).on('child_added', snap => {
      if (peer) peer.addIceCandidate(new RTCIceCandidate(snap.val()));
    });
  }

  function endCall() {
    if (peer) peer.close();
    document.getElementById('videoContainer').style.display = 'none';
    document.getElementById('audioContainer').style.display = 'none';
    db.ref('calls').remove();
    db.ref('offers').remove();
    db.ref('answers').remove();
    db.ref('ice').remove();
  }
</script>
</body>
</html>
